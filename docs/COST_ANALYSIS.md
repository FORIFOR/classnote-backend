# ClassnoteX クラウドコスト分析レポート

**作成日**: 2025-12-11  
**対象システム**: ClassnoteX Backend API  
**目的**: スケール別コスト試算、ボトルネック分析、リリース費用感の把握

---

## 1. エグゼクティブサマリー

### 月額コスト概算

| 規模 | MAU | 月間録音時間 | 月額概算 | 1人あたり月額 |
|------|-----|-------------|---------|--------------|
| **ベータ** | 10人 | 30時間 | **$15〜30** | $1.5〜3.0 |
| **100人規模** | 100人 | 300時間 | **$100〜180** | $1.0〜1.8 |
| **1,000人規模** | 1,000人 | 3,000時間 | **$850〜1,500** | $0.85〜1.5 |

> [!TIP]
> 現在の構成は1,000人規模まで**追加の設計変更なし**でスケール可能です。
> 主要コストドライバーは **Speech-to-Text API（60%）** と **Vertex AI Gemini（25%）** です。

### 最大のボトルネック

1. **LLM API のレスポンス時間** (10〜20秒/要約)
2. **Speech API のコスト** (リアルタイム: $0.024/分)
3. **Firestore の同期 I/O** (高負荷時のイベントループブロック)

---

## 2. アーキテクチャと使用サービス

```
┌─────────────────────────────────────────────────────────────────────┐
│                        GCP Services Used                            │
├─────────────────────────────────────────────────────────────────────┤
│  Cloud Run          │ API サーバー (FastAPI)                        │
│  Firestore          │ セッション・ユーザーデータ保存                  │
│  Cloud Storage      │ 音声ファイル保存                              │
│  Cloud Tasks        │ 非同期 LLM 処理キュー                         │
│  Speech-to-Text     │ リアルタイム音声認識                          │
│  Vertex AI (Gemini) │ 要約・クイズ・ハイライト生成                   │
│  Firebase Auth      │ ユーザー認証                                  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 詳細コスト内訳

### 3.1 想定利用パターン（1ユーザーあたり）

| 指標 | 値 | 備考 |
|------|-----|------|
| 月間録音回数 | 20回 | 週5回×4週 |
| 平均録音時間 | 15分 | 短い会議〜講義の一部 |
| 要約生成 | 15回/月 | 全録音の75%で要約 |
| クイズ生成 | 5回/月 | 一部の録音で生成 |

### 3.2 サービス別コスト（月額）

#### Cloud Run

| 規模 | vCPU時間 | メモリ時間 | 月額 |
|------|---------|-----------|------|
| 10人 | 10時間 | 20GB時間 | **$1〜2** (無料枠内) |
| 100人 | 100時間 | 200GB時間 | **$8〜15** |
| 1,000人 | 1,000時間 | 2,000GB時間 | **$80〜150** |

> 無料枠: 180,000 vCPU秒/月、360,000 GB秒/月

#### Firestore

| 規模 | Read/月 | Write/月 | 月額 |
|------|---------|----------|------|
| 10人 | 50,000 | 10,000 | **$0** (無料枠内) |
| 100人 | 500,000 | 100,000 | **$3〜5** |
| 1,000人 | 5,000,000 | 1,000,000 | **$30〜50** |

> 無料枠: 50,000 Read、20,000 Write、20,000 Delete/日

#### Cloud Storage

| 規模 | 保存容量 | 転送量 | 月額 |
|------|---------|--------|------|
| 10人 | 5GB | 10GB | **$0.5** |
| 100人 | 50GB | 100GB | **$5〜8** |
| 1,000人 | 500GB | 1,000GB | **$50〜80** |

> 単価: $0.02/GB (Storage), $0.12/GB (Egress)

#### Speech-to-Text API ⚠️ **最大コスト**

| 規模 | 録音時間/月 | 月額 |
|------|------------|------|
| 10人 | 30時間 | **$43** |
| 100人 | 300時間 | **$432** |
| 1,000人 | 3,000時間 | **$4,320** |

> 単価: $0.024/分 (リアルタイム Streaming)

> [!CAUTION]
> Speech API が最大のコストドライバーです。
> **代替案**: Whisper (オンプレ/Cloud Run Jobs) で大幅削減可能 → 後述

#### Vertex AI Gemini

| 規模 | 入力Token/月 | 出力Token/月 | 月額 |
|------|-------------|-------------|------|
| 10人 | 1.5M | 150K | **$1〜2** |
| 100人 | 15M | 1.5M | **$15〜20** |
| 1,000人 | 150M | 15M | **$150〜200** |

> 単価: $0.00075/1K入力, $0.003/1K出力 (Gemini 1.5 Flash)

#### Cloud Tasks

| 規模 | タスク数/月 | 月額 |
|------|-----------|------|
| 全規模 | ≤1M | **$0** (無料枠内) |

> 無料枠: 100万タスク/月

### 3.3 コスト合計表

| サービス | 10人 | 100人 | 1,000人 |
|----------|------|-------|---------|
| Cloud Run | $1 | $12 | $120 |
| Firestore | $0 | $4 | $40 |
| Cloud Storage | $1 | $7 | $65 |
| **Speech API** | **$43** | **$432** | **$4,320** |
| Vertex AI | $2 | $18 | $175 |
| Cloud Tasks | $0 | $0 | $0 |
| **合計** | **$47** | **$473** | **$4,720** |

> [!WARNING]
> Speech API を使う限り、1,000人規模で月額 $4,700+ になります。
> Whisper に置き換えると $500〜800 に削減可能です。

---

## 4. コスト最適化オプション

### Option A: Speech API → Whisper 置換 (推奨)

| 項目 | 現状 (Speech API) | Whisper (Cloud Run Jobs) |
|------|------------------|-------------------------|
| 1,000時間あたり | $1,440 | $100〜200 |
| リアルタイム性 | ○ | △ (録音後処理) |
| 精度 | ◎ | ○〜◎ |

**メリット**:
- コスト 90% 削減
- API 従量課金の上限リスクなし

**デメリット**:
- リアルタイム文字起こし不可 (録音後に処理)
- 自前で GPU インスタンス管理が必要

### Option B: Gemini 1.5 Flash → Pro へのアップグレード

長文書処理の効率化で token 数削減可能:
- 段階的要約 (チャンク分割)
- 出力の構造化 (JSON Mode)

### Option C: Firestore → BigQuery 分析用途

読み取り頻度の高いログ・分析データを BigQuery に移行:
- Firestore Read コスト削減
- 分析クエリが高速化

---

## 5. ボトルネック分析

### 5.1 パフォーマンスボトルネック

| ランク | ボトルネック | 影響 | 改善策 |
|--------|------------|------|--------|
| 🔴 1 | LLM API レスポンス (10〜20秒) | 要約画面の待ち時間 | ✅ 非同期化済み (Cloud Tasks) |
| 🟡 2 | Firestore 同期 I/O | 高負荷時のスループット低下 | AsyncIO クライアント導入 |
| 🟡 3 | WebSocket + Speech API | 接続維持のメモリ使用 | min_instances 調整 |

### 5.2 スケーラビリティ限界

| 指標 | 現状の限界 | 制約要因 |
|------|-----------|---------|
| 同時接続 (WebSocket) | 〜100接続/インスタンス | Cloud Run メモリ |
| 同時要約リクエスト | 〜50 req/sec | Cloud Tasks キュー |
| Gemini API | 〜60 req/min | Vertex AI Quota |
| Speech API | 〜100 同時ストリーム | Google Cloud Quota |

> [!NOTE]
> 1,000人規模では **同時アクティブユーザー 50〜100人** を想定。
> ピーク時でも現状アーキテクチャで対応可能です。

### 5.3 技術的負債

| 項目 | 影響度 | 対応済み |
|------|--------|---------|
| `auth.py` の sync def | 中 | ✅ 対応済み (httpx) |
| batch_delete の N+1 | 低 | ✅ 対応済み |
| summarize の race condition | 中 | ✅ Transaction 化済み |
| Firestore 同期 I/O | 中〜高 | ⏳ 未対応 (将来課題) |

---

## 6. リリース費用の見積もり

### 6.1 初期費用 (ゼロ)

GCP はすべて従量課金のため、初期費用は **$0** です。

### 6.2 ベータ運用 (10人)

| 項目 | 月額 |
|------|------|
| インフラ (Speech 除く) | $5 |
| Speech API | $43 |
| **合計** | **$48/月** |

> Speech を Whisper に置き換えると **$10/月** 以下

### 6.3 正式リリース目安

| フェーズ | ユーザー数 | 月額コスト | 備考 |
|----------|----------|-----------|------|
| α版 | 10人 | $50 | 無料提供可能 |
| β版 | 50人 | $250 | 月額500円×50人で回収可 |
| 正式版 | 100人 | $500 | 月額500円×100人で黒字 |
| グロース | 1,000人 | $1,000〜5,000 | Whisper 化が必須 |

### 6.4 損益分岐点

| 月額課金 | 必要ユーザー数 (現状) | 必要ユーザー数 (Whisper化後) |
|----------|---------------------|---------------------------|
| ¥500 | 95人 | 20人 |
| ¥980 | 48人 | 10人 |
| ¥1,500 | 32人 | 7人 |

---

## 7. 推奨アクション

### 短期 (リリースまで)

1. **Whisper 導入を検討**  
   - Speech API コストが全体の 90% を占める
   - リアルタイム性が不要なら Whisper で 10分の1 以下に

2. **Gemini Quota 確認**  
   - Vertex AI のデフォルト Quota を確認
   - 必要なら増加申請

### 中期 (リリース後)

3. **Firestore AsyncIO 移行**  
   - 高負荷時のスループット改善
   - スケール時の安定性確保

4. **コスト監視アラート設定**  
   - Cloud Billing → Budget Alert
   - 想定の 150% で通知設定

### 長期 (1,000人超)

5. **音声処理の分離**  
   - Whisper を Cloud Run Jobs に分離
   - GPU インスタンスでバッチ処理

6. **マルチリージョン検討**  
   - Firestore のマルチリージョン
   - Cloud CDN の導入

---

## 8. まとめ

| 項目 | 評価 | コメント |
|------|------|----------|
| **100人規模** | ✅ 現状で対応可能 | 月額 $500 以下 |
| **1,000人規模** | ⚠️ 要最適化 | Speech API 置換で対応可能 |
| **最大ボトルネック** | Speech API コスト | Whisper 化で解決 |
| **リリース推奨** | ✅ | β版なら月額 $50〜100 で開始可能 |

> [!TIP]
> **結論**: 現状のアーキテクチャは 100人規模まで問題なくスケール可能。
> 1,000人規模を目指す場合は Speech API の置換が必須。
> リリース自体は $50/月 程度から可能で、ユーザー課金で十分回収可能な費用感です。
